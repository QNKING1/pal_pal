<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Pal Pal – Lyrics Sync</title>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500&display=swap" rel="stylesheet">

    <style>
        /* Page layout */
        body {
            margin: 0;
            height: 100vh;
            background: radial-gradient(circle at top, #0f0b18 0%, #000 100%);
            color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Playfair Display', serif;
            overflow: hidden; /* Do not allow page scroll */
        }

        .container {
            text-align: center;
            width: min(880px, 94%);
            padding: 28px;
            animation: fadeIn 900ms ease;
            background: linear-gradient(180deg, rgba(18,10,35,0.6), rgba(10,6,18,0.6));
            border-radius: 18px;
            box-shadow: 0 10px 60px rgba(120, 46, 242, 0.12), 0 2px 8px rgba(0,0,0,0.6);
        }

        h1 {
            font-size: 2.6rem;
            color: #d8c9ff;
            margin: 0 0 6px 0;
            text-shadow: 0 0 20px #7b2ff2, 0 0 2px #fff;
        }

        .subtitle {
            opacity: 0.8;
            margin-bottom: 18px;
            color: #bdaee8;
        }

        /* Hide native controls but keep audio element for playback */
        audio {
            display: none;
        }

        /* Custom player */
        .custom-audio-player {
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(180deg, rgba(30,18,56,0.55), rgba(20,10,40,0.45));
            border-radius: 14px;
            padding: 12px 14px;
            justify-content: center;
            width: 100%;
            max-width: 760px;
            margin: 0 auto 18px auto;
            box-shadow: 0 6px 30px rgba(123,47,242,0.08), inset 0 1px 0 rgba(255,255,255,0.02);
        }

        .play-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #7b2ff2 0%, #f357a8 120%);
            color: white;
            font-size: 18px;
            display: inline-grid;
            place-items: center;
            cursor: pointer;
            box-shadow: 0 0 18px rgba(123,47,242,0.6);
        }

        .play-btn:active { transform: scale(0.98); }

        .progress-bar {
            --h: 10px;
            height: var(--h);
            flex: 1 1 auto;
            background: rgba(40,20,70,0.6);
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            box-shadow: inset 0 0 8px rgba(123,47,242,0.08);
        }
        .progress { height: 100%; width: 0%; border-radius: 8px; background: linear-gradient(90deg,#7b2ff2,#f357a8); box-shadow: 0 0 18px rgba(123,47,242,0.6); transition: width 0.12s linear; }

        .time { min-width: 70px; color: #d9cfff; font-family: monospace; font-size: 0.98rem; text-shadow: 0 0 8px #7b2ff2; }

        /* Lyrics box - fixed height scroll area */
        .lyrics-outer {
            max-height: 260px;
            min-height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px 18px;
            margin: 18px auto 8px auto;
            background: linear-gradient(180deg, rgba(16,8,30,0.48), rgba(10,6,18,0.35));
            border-radius: 12px;
            box-shadow: inset 0 0 28px rgba(123,47,242,0.06);
        }
        .lyrics-outer::-webkit-scrollbar { width: 8px; }
        .lyrics-outer::-webkit-scrollbar-thumb { background: rgba(123,47,242,0.85); border-radius: 8px; }

        .lyrics-box { text-align: left; font-size: 1.35rem; line-height: 1.6; color: #fff; }
        .lyrics-box div { padding: 6px 0; }
        .lyrics-box div.active { color: #ffd7f0; font-weight: 600; text-shadow: 0 0 12px #f357a8; }

        /* Waveform container */
        .waveform-container { width: 100%; max-width: 760px; margin: 12px auto 6px auto; display: flex; justify-content:center; }
        #waveform { width: 100%; height: 96px; border-radius: 10px; display:block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

        /* small screens */
        @media (max-width:420px){ h1{font-size:1.8rem;} .lyrics-outer{max-height:200px;} }
    </style>
</head>

<body>
    <div class="container">
        <h1>Pal Pal</h1>
        <div class="subtitle">Lyrics appear exactly when they are sung</div>

        <!-- Hidden native audio element -->
        <audio id="audio">
            <source src="song.mp3" type="audio/mpeg">
            Your browser does not support audio.
        </audio>

        <!-- Custom audio controls -->
        <div class="custom-audio-player" id="customPlayer">
            <button class="play-btn" id="playPauseBtn" aria-label="Play/Pause">▶</button>
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
            </div>
            <div class="time" id="currentTime">0:00</div>
            <div style="color:#777;">/</div>
            <div class="time" id="duration">0:00</div>
        </div>

        <!-- Waveform -->
        <div class="waveform-container">
            <canvas id="waveform"></canvas>
        </div>

        <!-- Lyrics -->
        <div class="lyrics-outer" id="lyricsOuter">
            <div class="lyrics-box" id="lyrics"></div>
        </div>
    </div>

    <script>
        // Elements
        const audio = document.getElementById('audio');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const lyricsOuter = document.getElementById('lyricsOuter');
        const container = document.getElementById('lyrics');
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');

        // Lyrics data (unchanged timing logic)
        const lyrics = [
            { start: 35.5, text: "Main ab kyun hosh mein aata nahi?" },
            { start: 37, text: "Sukoon yeh dil kyun paata nahi?" },
            { start: 38, text: "Kyun todun khud se jo the waade?" },
            { start: 42, text: "Ke ab yeh ishq nibhana nahi" },
            { start: 44.5, text: "Main modun tumse jo yeh chehra" },
            { start: 46, text: "Dobara nazar milana nahi" },
            { start: 49, text: "Yeh duniya jaane mera dard" },
            { start: 51, text: "Tujhe yeh nazar kyun aata nahi?" }
        ];

        // Typing / sync state
        let currentLine = 0;
        let typingInterval = null;
        let charIndex = 0;

        function stopTyping(){
            clearInterval(typingInterval);
            typingInterval = null;
            charIndex = 0;
        }

        function typeLine(text){
            stopTyping();
            const div = document.createElement('div');
            div.className = 'active';
            container.appendChild(div);
            // Smoothly animate typing and auto-scroll
            typingInterval = setInterval(()=>{
                if(charIndex < text.length){
                    div.textContent += text[charIndex++];
                    // auto-scroll while typing with smooth behavior
                    lyricsOuter.scrollTo({ top: lyricsOuter.scrollHeight, behavior: 'smooth' });
                } else {
                    stopTyping();
                    currentLine++;
                    lyricsOuter.scrollTo({ top: lyricsOuter.scrollHeight, behavior: 'smooth' });
                }
            }, 48);
        }

        function fullResync(time){
            stopTyping();
            container.innerHTML = '';
            currentLine = 0;
            while(currentLine < lyrics.length && lyrics[currentLine].start <= time){
                const div = document.createElement('div');
                div.textContent = lyrics[currentLine].text;
                container.appendChild(div);
                currentLine++;
            }
            // ensure bottom visible
            lyricsOuter.scrollTo({ top: lyricsOuter.scrollHeight, behavior: 'auto' });
        }

        // Audio controls
        function formatTime(sec){
            if(isNaN(sec)) return '0:00';
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}:${s.toString().padStart(2,'0')}`;
        }

        function updateProgress(){
            const pct = (audio.currentTime / audio.duration) * 100 || 0;
            progress.style.width = pct + '%';
            currentTimeEl.textContent = formatTime(audio.currentTime);
        }

        audio.addEventListener('loadedmetadata', ()=>{
            durationEl.textContent = formatTime(audio.duration);
            updateProgress();
        });

        audio.addEventListener('timeupdate', ()=>{
            updateProgress();
            // Lyrics sync preserved
            if(currentLine < lyrics.length && audio.currentTime >= lyrics[currentLine].start && !typingInterval){
                typeLine(lyrics[currentLine].text);
            }
        });

        audio.addEventListener('seeked', ()=>{
            fullResync(audio.currentTime);
            updateProgress();
        });

        playPauseBtn.addEventListener('click', ()=>{
            if(audio.paused) audio.play(); else audio.pause();
        });
        audio.addEventListener('play', ()=>{ playPauseBtn.textContent = '❚❚'; startVisualizer(); });
        audio.addEventListener('pause', ()=>{ playPauseBtn.textContent = '▶'; stopVisualizer(); });
        audio.addEventListener('ended', ()=>{ playPauseBtn.textContent = '▶'; stopVisualizer(); });

        // Seek via progress bar
        progressBar.addEventListener('click', (e)=>{
            const r = progressBar.getBoundingClientRect();
            const x = e.clientX - r.left;
            const pct = x / r.width;
            audio.currentTime = pct * audio.duration;
            updateProgress();
        });

        // --- Improved waveform visualizer ---
        let audioCtx = null, analyser = null, source = null;
        let timeData = null, freqData = null;
        let rafId = null;

        // smoothing state to create fluid motion
        let smoothed = null;

        function setupAudioCtx(){
            if(audioCtx) return;
            audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048; // higher resolution for smoother curve
            const bufferLen = analyser.fftSize;
            timeData = new Uint8Array(bufferLen);
            freqData = new Uint8Array(analyser.frequencyBinCount);
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            // initialize smoothing array
            smoothed = new Float32Array(bufferLen).fill(0);
            resizeCanvas();
        }

        // Handle HiDPI
        function resizeCanvas(){
            const dpr = window.devicePixelRatio || 1;
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            canvas.width = Math.max(300, Math.floor(width * dpr));
            canvas.height = Math.max(80, Math.floor(height * dpr));
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        window.addEventListener('resize', ()=>{ resizeCanvas(); });

        // utility lerp
        function lerp(a,b,t){ return a + (b-a)*t; }

        function drawVisualizer(){
            if(!analyser) return;
            analyser.getByteTimeDomainData(timeData);
            analyser.getByteFrequencyData(freqData);

            const w = canvas.clientWidth;
            const h = canvas.clientHeight;
            ctx.clearRect(0,0,w,h);

            // background subtle glow
            const gradBg = ctx.createLinearGradient(0,0,w,0);
            gradBg.addColorStop(0, 'rgba(123,47,242,0.06)');
            gradBg.addColorStop(1, 'rgba(243,87,168,0.02)');
            ctx.fillStyle = gradBg;
            ctx.fillRect(0,0,w,h);

            // map data to a smooth waveform using smoothed buffer
            const step = Math.floor(timeData.length / Math.min(120, Math.floor(w/2)));
            const centerY = h/2;
            const scaleY = h * 0.38;

            // update smoothing - low-pass filter style
            for(let i=0;i<timeData.length;i+=step){
                const v = (timeData[i] - 128) / 128; // -1..1
                const idx = i;
                smoothed[idx] = lerp(smoothed[idx] || 0, v, 0.12); // smoothing factor
            }

            // draw layered curves (three passes) for depth
            for(let pass=0; pass<3; pass++){
                const opacity = [0.22, 0.14, 0.06][pass];
                const blur = [18, 10, 4][pass];
                ctx.beginPath();
                let x = 0;
                const spacing = w / (timeData.length / step);
                let first = true;
                let px = 0, py = 0;
                let iIndex = 0;
                for(let i=0;i<timeData.length;i+=step){
                    const v = smoothed[i] || 0;
                    const y = centerY + v * scaleY * (1 - pass*0.18); // smaller amplitude on back passes
                    const drawX = x;
                    if(first){ ctx.moveTo(drawX, y); first=false; }
                    else {
                        // smooth with quadratic curve
                        const cx = (px + drawX)/2;
                        const cy = (py + y)/2;
                        ctx.quadraticCurveTo(px, py, cx, cy);
                    }
                    px = drawX; py = y;
                    x += spacing;
                    iIndex++;
                }
                ctx.lineWidth = 2.4 - pass*0.7;
                ctx.strokeStyle = `rgba(243,87,168, ${opacity})`;
                ctx.shadowColor = `rgba(123,47,242, ${opacity*2})`;
                ctx.shadowBlur = blur;
                ctx.stroke();
            }

            // small frequency-reactive dots along bottom for sparkle
            const freqLen = Math.min(freqData.length, 160);
            for(let i=0;i<freqLen;i+=6){
                const mag = freqData[i] / 255; // 0..1
                const xpos = (i / freqLen) * w;
                const ypos = h - (mag * 18) - 6;
                const r = 1.2 + mag * 3.0;
                ctx.beginPath();
                ctx.fillStyle = `rgba(123,47,242, ${0.16 + mag*0.6})`;
                ctx.arc(xpos, ypos, r, 0, Math.PI*2);
                ctx.fill();
            }
        }

        function animate(){
            drawVisualizer();
            rafId = requestAnimationFrame(animate);
        }

        function startVisualizer(){
            setupAudioCtx();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(!rafId) animate();
        }
        function stopVisualizer(){
            if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
            // keep last frame (no clearing) for paused effect
        }

        // Ensure audioContext resumes on a user gesture if required
        document.body.addEventListener('click', ()=>{
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: false });

        // initial setup
        resizeCanvas();
        fullResync(0);

    </script>
</body>

</html>
